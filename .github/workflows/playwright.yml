name: Playwright E2E Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      SAUCE_PASSWORD: ${{ secrets.SAUCE_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # Cache node_modules
      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}

      # Cache Playwright browsers
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # Run Playwright tests (Chromium + WebKit)
      - name: Run Playwright tests
        run: npx playwright test --reporter=allure-playwright,html

      # Upload artifacts
      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report

  deploy-reports:
    runs-on: ubuntu-latest
    needs: [e2e]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # Download artifacts
      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: reports/allure-results

      - name: Download Playwright HTML report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: reports/playwright-temp

      # Generate Allure HTML report
      - name: Generate Allure report
        run: |
          mkdir -p reports/allure-report
          npx allure generate reports/allure-results --clean -o reports/allure-report

      # Copy Playwright HTML report
      - name: Copy Playwright report
        run: |
          mkdir -p reports/playwright
          cp -r reports/playwright-temp/* reports/playwright/

      # Create landing page linking for 3 reports
      - name: Create professional landing page
        run: |
          TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
          echo "<!DOCTYPE html>
          <html lang='en'>
          <head>
            <meta charset='UTF-8'>
            <title>Landing Page - E2E Test Reports</title>
            <style>
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f4f6f8;
                margin: 50px;
                color: #2c3e50;
              }
              h1 {
                color: #1abc9c;
                font-size: 2.5em;
                margin-bottom: 5px;
              }
              p.timestamp {
                font-size: 0.95em;
                color: #7f8c8d;
                margin-bottom: 30px;
              }
              ul {
                list-style: none;
                padding: 0;
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
              }
              ul li {
                margin: 10px 0;
              }
              ul li a {
                text-decoration: none;
                font-size: 1.1em;
                padding: 12px 20px;
                background: linear-gradient(135deg, #1abc9c, #16a085);
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                transition: transform 0.2s, box-shadow 0.2s;
              }
              ul li a:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.15);
              }
            </style>
          </head>
          <body>
            <h1>Landing Page - E2E Test Reports</h1>
            <p class='timestamp'>Last run: $TIMESTAMP</p>
            <ul>
              <li><a href='custom-report/index.html'>Custom Report</a></li>
              <li><a href='allure-report/index.html'>Allure Report</a></li>
              <li><a href='playwright/index.html'>Playwright HTML Report</a></li>
            </ul>
          </body>
          </html>" > reports/index.html

      # Deploy all reports to GitHub Pages
      - name: Deploy All Reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports